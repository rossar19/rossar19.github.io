---
layout: noheader
---

<h1 class="data-header">Header</h1>
<p class="data-copy">Copy goes here.  Lorem ipsum dolor sit amet, consectetur adipisicing elit,
sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad
minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea
commodo consequat. Duis aute irure dolor in reprehenderit in voluptate .</p>

<div class="main-wrapper--countries"></div>
<div class="main-wrapper--data"></div>

<script>
	var pageTitle = "Header";
	var cIndex;              // Index of country currently viewed
	var avgQ2ByCountry = []; // Array of each country's average happy rating

	// Data nested by categories
	var childrenNest;
	var countryNest;
	var happyNest;
	var genderNest;
	var ageNest;
	var employmentNest;
	var relationshipNest;
	var happyCountryNest;

	var filters; // Categories to filter data

	// Keys in data
	var qHappiness = "Q2. Imagine a ladder with steps numbered from 0 at the bottom to 10 at the top.  The top represents the best possible life for you; the bottom, the worst possible life.  On which step do you feel you personally stand at present time?";
	var qGender = "Q132. Gender";
	var qAge = "Q133. How old were you at your last birthday?";
	var qEmployment = "Q140. Which of the following employment situations best describes your current status?";
	var qRelationship = "Q153. Are you currently married, in a legal civil union, widowed, divorced, separated, or none of these?";
	var qChildren = "Q157. How many children have you had?  Please count all your biological children who were born at any time in your life. [In Russia: but do not count adopted children or stepchildren].";

	var simulation; // Force simulation used for particles

	// Draw each country and color based on average happiness
	var drawAvg = function(data) {
		var svg = d3.select(".main-wrapper--countries")
			.append("svg")
			.attr("class", "country--svg");

		var rects = svg.selectAll("rect").data(data);     // Element for country
		var nameText = svg.selectAll("text").data(data);  // Element for country's name

		// Assign color based on average
	    var color = d3.scaleLinear()
	    .domain([2, 5, 8])
	    .range(["#000", "#91719a", "#f5c750"]);

	    // "#000", "#46535a", "#465f2c", 
	    // 		"#984350", "#91719a", "#f5c750", 
	    // 		"#a8c9d9", "#c1dea0", "#d796a5", 
	    // 		"#cdb5d7", "#f3d998"

	    // "#F00", "#00F", "#0F0"

	    // Add rectangle to SVG
		rects.enter().append("rect")
		.attr("id", function(d, i) {
			return "c" + i;
		})
		.attr("class", "country")
		.attr("x", function(d, i) {
			return 20 + (120*(i%10));
		})
		.attr("y", function(d, i) {
			return 20 + (190 * Math.floor(i/10));
		})
		.attr("width", 100)
		.attr("height", 150)
		.attr("fill", function(d, i) {
			return color(avgQ2ByCountry[i]);
		})
		.on("mouseover", function(d, i) {
			var x = d3.select(this).attr("x");
			var y = d3.select(this).attr("y");
			d3.select(".main-wrapper--countries")
				.append("span")
				.attr("class", "avg")
				.text(avgQ2ByCountry[i].toFixed(1));
		})
		.on("mouseout", function(d, i) {
			d3.select(".main-wrapper--countries .avg")
				.remove();
		});

		// Add Text element to SVG
	    nameText.enter().append("text")
	    .attr("x", function(d, i) {
	      return 20 + (120*(i%10));
	    })
	    .attr("y", function(d, i) {
	    	return 15 + (190 * Math.floor(i/10));
	    })
	    .attr("id", function(d, i) {
	    	return "L" + i;
	    })
	    .attr("class", "country--name")
	    .text(function(d) {
	    	return d.key;
	    });

	    createOnClick(data);
	}

	// Creates an on click function for each item in data
	function createOnClick(data) {
	    for (var n in data) {
	    	var id = "#c" + n;
	    	var mDataWrapper = d3.select(".main-wrapper--data");

			d3.select(id).on("click", function(e) {
				cIndex = this.id.replace("c", "");
				d3.select(".data-header").text(data[cIndex].key);

				d3.select(".main-wrapper--countries").style("display", "none");

				mDataWrapper.selectAll("*").remove();
				mDataWrapper.style("display", "block");
				addFilterBtns();
			});
	    }
	}

	// Adds filter buttons
	function addFilterBtns() {
	    var mDataWrapper = d3.select(".main-wrapper--data");

		var btnWrap = mDataWrapper
			.append("div")
			.attr("class", "btn-wrapper");

		var dataWrap = mDataWrapper
			.append("div")
			.attr("class", "data-wrapper");

		d3.select(".data-copy")
			.append("a")
			.attr("class", "back-btn")
			.attr("href", "javascript:goBack()")
			.text("Choose a different country");

		// Return an array of keys from data's children
		function getChildArr(data) {
			var arr = [];

			if (isNaN(parseInt(data[0].key))) {
				for (var n in data) {
					if (data[n].key != "Refused" && data[n].key != "Dont know") {
						arr.push(data[n].key);
					}
				}
			} else {
				for (var n in data) {
					if (data[n].key < 98 && data[n].key != "") {
						arr.push(data[n].key);
					}
				}
			}
			return arr;
		}

		filters = {
			"Happy": getChildArr(happyNest),
			"Sex": getChildArr(genderNest),
			"Age": getChildArr(ageNest).sort(function(a,b) {return a-b}),
			"Job Status": getChildArr(employmentNest),
			"Marital Status": getChildArr(relationshipNest),
			"# of Children": getChildArr(childrenNest).sort(function(a,b) {return a-b})
		};

		// Create a button for each item in filters and create onclick functions
		for (var n in filters) {
			var btn = btnWrap.append("button")
			.attr("id", n)
			.attr("class", "filter-btn")
			.text(n);

			// If first load, display subcategories of first item in filters
			if (d3.select(".data-wrapper").html() == "") {
				displaySubs(filters[n], n);
			}

			// On click, clear old children and add new subcategories
			btn.on("click", function(e) {
				dataWrap.selectAll("*").remove();
				displaySubs(filters[this.id], this.id);
			});
		}
	}

	// Add subcategories to page
	function displaySubs(arr, filter) {
		var objArr = [];

		for (var n in arr) {
			d3.select(".data-wrapper").append("span")
				.attr("class", "category")
				.text(arr[n]);
		}

		setSubcatCoords(objArr);
		drawClusters(countryNest, objArr, cIndex, filter);
	}

	// Calculate subcategory coordinates for data positioning, and push object to array 
	function setSubcatCoords(arr) {
		d3.selectAll(".category").each(function() {
			var w = this.getBoundingClientRect().width;
			var h = this.getBoundingClientRect().height;
			var l = this.getBoundingClientRect().left;
			var t = this.getBoundingClientRect().top;

			var xOffset = d3.select(".data-wrapper").node().getBoundingClientRect().left;
			var yOffset = d3.select(".data-wrapper").node().getBoundingClientRect().top;

			var temp = {
				"key": d3.select(this).text(),
				"x": l + (w/2) - xOffset,
				"y": t + (h/2) - yOffset
			}

			arr.push(temp);
		});
	}

	// Return to homepage
	function goBack() {
		d3.select('.back-btn').remove();
		d3.select('.data-header').text(pageTitle);
		d3.select('.main-wrapper--data').style("display", "none");
		d3.select('.main-wrapper--countries').style("display", "block");

		simulation.stop();
		d3.select(".data-wrapper svg").remove();
	}

	// Draw each participants response and place under subcategories
	function drawClusters(data, objArr, countIndex, filter) {
		if (simulation != null) { simulation.stop(); }


		var filKey;  // Data key associated with active filter
		var width = 900,
		    height = d3.select(".data-wrapper")
		    	.node()
		    	.getBoundingClientRect()
		    	.height + 100;

		switch(filter) {
			case "Happy":
				filKey = qHappiness;
				break;
			case "Sex":
				filKey = qGender;
				break;
			case "Age":
				filKey = qAge;
				break;
			case "Job Status":
				filKey = qEmployment;
				break;
			case "Marital Status":
				filKey = qRelationship;
				break;
			case "# of Children":
				filKey = qChildren;
				break;
			default:
				filKey = "Something went wrong...";
		}

		simulation = d3.forceSimulation()
            .force("collide",d3.forceCollide(2))
            .force("charge", d3.forceManyBody().strength(-5))
            .force("y", d3.forceY(function(d) {
            		var temp = -999;  // Lazily hide the things that don't apply
            		for (var i = 0; i < objArr.length; i++) {
            			if (d[filKey].includes(objArr[i].key)) {
            				temp = objArr[i].y;
            			}
            		}
	            	return temp;
	            })
            	.strength(0.5))
            .force("x", d3.forceX(function(d) {
            		var temp = -999;
            		for (var i = 0; i < objArr.length; i++) {
            			if (d[filKey].includes(objArr[i].key)) {
            				temp = objArr[i].x;
            			}
            		}
	            	return temp;
            	})
            	.strength(0.5));

		var svg = d3.select(".data-wrapper").append("svg").attr("width", width).attr("height", height);
		var circles = svg.selectAll("circle").data(data[countIndex].values);


	    // var color = d3.scaleLinear()
	    // .domain([0, 10])
	    // .range(["#0C00FF", "#FF9C00"]);

	    var color = d3.scaleLinear()
	    .domain([0,1,2,3,4,5,6,7,8,9,10])
	    .range(["#000", "#46535a", "#465f2c", 
	    		"#984350", "#91719a", "#f5c750", 
	    		"#a8c9d9", "#c1dea0", "#d796a5", 
	    		"#cdb5d7", "#f3d998"]);

		var circle = circles.enter()
			.append("circle")
			.attr("r", 2)
			.attr("fill", function(d, i) {
				var happy = d[qHappiness];
				if (parseInt(happy) < 97 && happy != "") {
					return color(happy);
				} else {
					return "black";
				}
			});

        function ticked(e) {
            circle
                .attr("cx", function(d) { return d.x; })
                .attr("cy", function(d) { return d.y; });
        }
        
        simulation
            .nodes(data[countIndex].values)
            .on("tick", ticked);
	}

	d3.csv("Global Attitudes - shortCSV.csv", function(error, data) {
		function nestDataBy(category) {
			return d3.nest()
				.key(function(d, i) {
					return d[category];
				})
				.entries(data);
		}

		countryNest = nestDataBy("Country");
		happyNest = nestDataBy(qHappiness);
		genderNest = nestDataBy(qGender);
		ageNest = nestDataBy(qAge);
		employmentNest = nestDataBy(qEmployment);
		relationshipNest = nestDataBy(qRelationship);
		childrenNest = nestDataBy(qChildren);
		function nestHappyInCountry() {
			return d3.nest()
				.key(function(d, i) {
					return d.Country;
				})
				.key(function(d, i) {
					return d[qHappiness];
				})
				.entries(data);
		}

		happyCountryNest = nestHappyInCountry();

		// Calculate average happiness for each country and push to avgQ2ByCountry
  		for (var i = 0; i < countryNest.length; i++) {
  			var temp = 0;
  			var total = countryNest[i].values.length;
  			for (var j = 0; j < countryNest[i].values.length; j++) {
  				var val = countryNest[i].values[j][qHappiness];
  				if (!isNaN(parseInt(val)) && parseInt(val) != 98 && parseInt(val) != 99) {
  					temp = temp + parseInt(val);
  				} else { total = total - 1; }
  			}
  			var average = temp / total;
  			avgQ2ByCountry.push(average);
  		}

	  	console.log(countryNest);
	  	drawAvg(countryNest);
	});
</script>