---
layout: noheader
---

<h1 class="data-header">Header</h1>
<p class="data-copy">Copy goes here.  Lorem ipsum dolor sit amet, consectetur adipisicing elit,
sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad
minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea
commodo consequat. Duis aute irure dolor in reprehenderit in voluptate .</p>

<div class="main-wrapper--countries"></div>
<div class="main-wrapper--data"></div>

<script>
	var pageTitle = "Header";
	var currCountryIndex;
	var avgQ2ByCountry = [];
	var childrenNest;
	var countryNest;
	var genderNest;
	var ageNest;
	var employmentNest;
	var relationshipNest;
	var happyCountryNest;

	var qHappiness = "Q2. Imagine a ladder with steps numbered from 0 at the bottom to 10 at the top.  The top represents the best possible life for you; the bottom, the worst possible life.  On which step do you feel you personally stand at present time?";
	var qGender = "Q132. Gender";
	var qAge = "Q133. How old were you at your last birthday?";
	var qEmployment = "Q140. Which of the following employment situations best describes your current status?";
	var qRelationship = "Q153. Are you currently married, in a legal civil union, widowed, divorced, separated, or none of these?";
	var qChildren = "Q157. How many children have you had?  Please count all your biological children who were born at any time in your life. [In Russia: but do not count adopted children or stepchildren].";

	var simulation;

	var drawAvg = function(data) {
		var svg = d3.select(".main-wrapper--countries").append("svg").attr("class", "country--svg");

		var rects = svg.selectAll("rect").data(data);
		var nameText = svg.selectAll("text").data(data);


	    var radius = d3.scaleLinear()
	    .domain([2, 5, 8])
	    .range(["#F00", "#00F", "#0F0"]);

		rects.enter().append("rect")
		.attr("id", function(d, i) {
			return "c" + i;
		})
		.attr("class", "country")
		.attr("x", function(d, i) {
			return 20 + (120*(i%10));
		})
		.attr("y", function(d, i) {
			return 20 + (190 * Math.floor(i/10))
		})
		.attr("width", 100)
		.attr("height", 150)
		.attr("fill", function(d, i) {
			return radius(avgQ2ByCountry[i]);
		});


	    nameText.enter().append("text")
	    .attr("x", function(d, i) {
	      return 20 + (120*(i%10));
	    })
	    .attr("y", function(d, i) {
	    	return 15 + (190 * Math.floor(i/10));
	    })
	    .attr("id", function(d, i) {
	    	return "L" + i;
	    })
	    .attr("class", "country--name")
	    .text(function(d) {
	    	return d.key;
	    });

	    for (var n in data) {
	    	var id = "#c" + n;

			d3.select(id).on("click", function(e) {
				var i = this.id.replace("c", "");
				d3.select(".data-header").text(data[i].key);

				currCountryIndex = i;
				console.log(currCountryIndex);

				d3.select(".main-wrapper--countries").style("display", "none");
				d3.select(".main-wrapper--data").selectAll("*").remove();

				addFilterBtns();
				d3.select(".main-wrapper--data").style("display", "block");
			});
	    }
	}

	var addFilterBtns = function() {
		var btnWrap = d3.select(".main-wrapper--data")
			.append("div")
			.attr("class", "btn-wrapper");

		var dataWrap = d3.select(".main-wrapper--data")
			.append("div")
			.attr("class", "data-wrapper");

		d3.select(".data-copy")
			.append("a")
			.attr("class", "back-btn")
			.attr("href", "javascript:goBack()")
			.text("Choose a different country");

		var getChildArr = function(data) {
			var arr = [];

			if (isNaN(parseInt(data[0].key))) {
				for (var n in data) {
					if (data[n].key != "Refused" && data[n].key != "Dont know") {
						arr.push(data[n].key);
					}
				}
			} else {
				for (var n in data) {
					if (data[n].key < 98 && data[n].key != "") {
						arr.push(data[n].key);
					}
				}
			}
			return arr;
		}

		var filters = {
			"Sex": getChildArr(genderNest),
			"Age": getChildArr(ageNest).sort(function(a,b) {return a-b}),
			"Job Status": getChildArr(employmentNest),
			"Marital Status": getChildArr(relationshipNest),
			"# of Children": getChildArr(childrenNest).sort(function(a,b) {return a-b})
		};

		for (var n in filters) {
			var btn = btnWrap.append("button")
			.attr("id", n)
			.attr("class", "filter-btn")
			.text(n);

			var html = d3.select(".data-wrapper");

			if (d3.select(".data-wrapper").html() == "") {
				displaySubs(filters[n]);
			}

			btn.on("click", function(e) {
				dataWrap.selectAll("*").remove();
				displaySubs(filters[this.id]);
			});
		}
	}

	var displaySubs = function(arr) {
		for (var n in arr) {
			d3.select(".data-wrapper").append("span").attr("class", "category").text(arr[n]);
		}
		
		drawClusters(countryNest, arr.length, currCountryIndex);
	}

	var goBack = function() {
		d3.select('.back-btn').remove();
		d3.select('.data-header').text(pageTitle);
		d3.select('.main-wrapper--data').style("display", "none");
		d3.select('.main-wrapper--countries').style("display", "block");

		simulation.stop();
		d3.select(".data-wrapper svg").remove();
	}

	var drawClusters = function(data, clusNum, countIndex) {
		if (simulation != null) { simulation.stop(); }

		var width = 900,
		    height = 500;
		var m = clusNum; // number of distinct clusters
		var x = d3.scaleLinear()
		    .domain([0, m])
		    .range([150, width]);

		    //set cx and cy for data nodes
		    // do position then try clustering

		simulation = d3.forceSimulation()
            .force("collide",d3.forceCollide(2))
            .force("charge", d3.forceManyBody().strength(-5))
            .force("y", d3.forceY(function(d, i) {
	            	var temp = x(Math.floor(Math.random() * (m/3)));
	            	return temp;
	            })
            	.strength(0.5))
            .force("x", d3.forceX(function(d, i) {
            		//console.log(20 + (120*(i%3)));
            		var temp = x(Math.floor(Math.random() * m));
            		//console.log(temp);
            		return temp;
            	})
            	.strength(0.5));

		var svg = d3.select(".data-wrapper").append("svg").attr("width", width).attr("height", height);
		var circles = svg.selectAll("circle").data(data[countIndex].values);


	    var color = d3.scaleLinear()
	    .domain([0, 10])
	    .range(["#0C00FF", "#FF9C00"]);

		var circle = circles.enter()
			.append("circle")
			.attr("r", 2)
			.attr("fill", function(d, i) {
				var happy = d[qHappiness];
				if (parseInt(happy) < 97 && happy != "") {
					return color(happy);
				} else {
					return "black";
				}
			});

        var ticked = function(e) {
            circle
                .attr("cx", function(d) { return d.x; })
                .attr("cy", function(d) { return d.y; });
        }
        
        simulation
            .nodes(data[countIndex].values)
            .on("tick", ticked);
	}

	d3.csv("Global Attitudes - shortCSV.csv", function(error, data) {

		var nestDataBy = function(category) {
			return d3.nest()
				.key(function(d, i) {
					return d[category];
				})
				.entries(data);
		}

		countryNest = nestDataBy("Country");
		genderNest = nestDataBy(qGender);
		ageNest = nestDataBy(qAge);
		employmentNest = nestDataBy(qEmployment);
		relationshipNest = nestDataBy(qRelationship);
		childrenNest = nestDataBy(qChildren);
		var nestHappyInCountry = function() {
			return d3.nest()
				.key(function(d, i) {
					return d.Country;
				})
				.key(function(d, i) {
					return d[qHappiness];
				})
				.entries(data);
		}

		happyCountryNest = nestHappyInCountry();

		console.log(nestHappyInCountry());

		/*
			pass country with happy nest to function
			get total number of participants for that country
			use scalelinear to produce happy circle size based on number of people
			use scalelinear to get color of happy circle
		*/

		//var avgQ2ByCountry = [];
  		for (var i = 0; i < countryNest.length; i++) {
  			var temp = 0;
  			var total = countryNest[i].values.length;
  			for (var j = 0; j < countryNest[i].values.length; j++) {
  				var val = countryNest[i].values[j][qHappiness];
  				if (!isNaN(parseInt(val)) && parseInt(val) != 98 && parseInt(val) != 99) {
  					temp = temp + parseInt(val);
  				} else { total = total - 1; }
  			}
  			var average = temp / total;
  			avgQ2ByCountry.push(average);
  		}

	  	console.log(countryNest);
	  	drawAvg(countryNest);
	});
</script>